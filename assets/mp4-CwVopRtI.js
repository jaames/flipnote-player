import{f as h}from"./index-CnXBYqmh.js";import{F as u}from"./FileSaver.min-Dnkgry9C.js";function d(n){function e(r){return r.reduce((a,s)=>(Array.isArray(s)&&(s=e(s)),a.concat(s)),[])}return e(n).filter(r=>!!r)}const f="/static/workers/ffmpeg-worker-mp4.js",p=419430400,g={slow:"slow",medium:"medium",fast:"ultrafast"};class b{constructor(){this.blob=null,this.totalFrames=0,this.scale=1,this.compression="medium",this.equalizer=!1}onvideocomplete(){}onerror(){}onprogress(e){}init({compression:e,scale:r,equalizer:a}){return this.compression=e,this.scale=r,this.equalizer=a,new Promise((s,c)=>{this.worker=new Worker(f),this.stdout="",this.stderr="",this.worker.onmessage=m=>{const t=m.data;switch(t.type){case"ready":s(this);break;case"stdout":this.stdout+=t.data+`
`;break;case"stderr":const o=t.data.match(/^frame=\s*([0-9]+)/);if(o){const i=parseInt(o[1]);this.onprogress(i/this.totalFrames*100)}this.stderr+=t.data+`
`;break;case"done":t.data.MEMFS.length?(this.blob=new Blob([t.data.MEMFS[0].data],{type:"video/mp4"}),this.oncomplete()):(this.onerror(),console.warn(this.stdout),console.warn(this.stderr)),this.worker.terminate();break;case"exit":console.log("exit");break}}})}convert(e){this.totalFrames=e.frameCount;const r=e.framerate;e.sampleRate;const a=e.duration,s=g[this.compression];return new Promise((c,m)=>{this.oncomplete=()=>{c(this)};const t=[],o=h.GifImage.fromFlipnote(e);t.push({name:"frames.gif",data:new Uint8Array(o.getArrayBuffer())});const i=e.getAudioMasterPcm(),l=e.sampleRate;t.push({name:"audio.raw",data:new Uint8Array(i.buffer)}),this.worker.postMessage({type:"run",TOTAL_MEMORY:p,MEMFS:t,arguments:d(["-hide_banner","-loglevel","info","-r",r.toString(),"-i","frames.gif","-f","s16le","-ar",`${l}`,"-ac","1","-i","audio.raw","-vcodec","libx264","-pix_fmt","yuv420p","-acodec","aac","-vf",`scale=iw*${this.scale}:ih*${this.scale}:flags=neighbor`,"-preset",s,"-tune","animation","-t",`${Math.floor(a/60)}:${a%60}`,"out.mp4"])})})}saveAs(e){u.saveAs(this.blob,e)}}export{b as default};
